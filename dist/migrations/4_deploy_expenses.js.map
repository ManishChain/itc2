{"version":3,"file":"4_deploy_expenses.js","sourceRoot":"","sources":["../../migrations/4_deploy_expenses.ts"],"names":[],"mappings":"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","sourcesContent":["import { deployFiniteStateMachineSystem } from '@settlemint/enteth-migration-utils';\nimport dayjs from 'dayjs';\n\nimport { AdminRoleRegistryContract } from '../types/truffle-contracts/AdminRoleRegistry';\nimport { ExpenseContract, ExpenseInstance } from '../types/truffle-contracts/Expense';\nimport { ExpenseRegistryContract } from '../types/truffle-contracts/ExpenseRegistry';\nimport { GateKeeperContract } from '../types/truffle-contracts/GateKeeper';\nimport { RevisorRoleRegistryContract } from '../types/truffle-contracts/RevisorRoleRegistry';\nimport { UserRoleRegistryContract } from '../types/truffle-contracts/UserRoleRegistry';\n\nconst GateKeeper: GateKeeperContract = artifacts.require('GateKeeper');\n\n// Expense\nconst ExpenseRegistry: ExpenseRegistryContract = artifacts.require('ExpenseRegistry');\nconst Expense: ExpenseContract = artifacts.require('Expense');\nconst AdminRoleRegistry: AdminRoleRegistryContract = artifacts.require('AdminRoleRegistry');\nconst UserRoleRegistry: UserRoleRegistryContract = artifacts.require('UserRoleRegistry');\nconst RevisorRoleRegistry: RevisorRoleRegistryContract = artifacts.require('RevisorRoleRegistry');\n\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst { enabledFeatures, storeIpfsHash } = require('../../truffle-config.js'); // two dirs up, because it is compiled into ./dist/migrations\n\nmodule.exports = async (deployer: Truffle.Deployer, network: string, accounts: string[]) => {\n  if (enabledFeatures().includes('EXPENSES')) {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const uiDefinitions = require('../../contracts/expense/UIDefinitions.json');\n    await deployFiniteStateMachineSystem(\n      deployer,\n      accounts,\n      GateKeeper,\n      Expense,\n      ExpenseRegistry,\n      [AdminRoleRegistry, UserRoleRegistry],\n      uiDefinitions\n    );\n    const dExpense = await Expense.deployed();\n\n    const dGateKeeper = await GateKeeper.deployed();\n    const allRoles = await dExpense.allRoles();\n    for (const role of allRoles) {\n      await dGateKeeper.createPermission(accounts[0], dExpense.address, role, accounts[0]);\n    }\n\n    const roleToRoleRegistries = {\n      ROLE_ADMIN: AdminRoleRegistry,\n      ROLE_USER: UserRoleRegistry,\n      ROLE_REVISOR: RevisorRoleRegistry,\n    };\n\n    for (const role of Object.keys(roleToRoleRegistries)) {\n      await dGateKeeper.grantPermission(\n        roleToRoleRegistries[role].address,\n        dExpense.address,\n        web3.eth.abi.encodeParameter('bytes32', web3.utils.fromAscii(role))\n      );\n    }\n\n    const expenses = [\n      {\n        amount: '19829',\n        proof: 'QmY9dQYk1Pm1ctcnoKCtpmFKNz6z9YpdhTqsLETEa44J1N',\n        localCurrencyAmount: '129812',\n        localCurrency: 'CFA',\n        exchangeRate: '654.647808',\n        resultAndActivity: 'R2_A1',\n        category: 'running_costs',\n        type: 'Meeting',\n        country: 'BJ',\n        settlement: 'cash',\n        incomeGeneratingActivity: 'no',\n        description: 'Appui alimentaire aux enfants de maman Marguerite',\n        supplier: 'Gold Business Center',\n        invoiceDate: dayjs('2019-03-12').unix(),\n      },\n    ];\n\n    for (const expense of expenses) {\n      await createExpense(dExpense, expense, accounts[0]);\n    }\n  }\n};\n\nasync function createExpense(expenseInstance: ExpenseInstance, expenseData: IExpenseData, owner: string) {\n  const ipfsHash = await storeIpfsHash({\n    localCurrencyAmount: expenseData.localCurrencyAmount,\n    localCurrency: expenseData.localCurrency,\n    exchangeRate: expenseData.exchangeRate,\n    resultAndActivity: expenseData.resultAndActivity,\n    category: expenseData.category,\n    country: expenseData.country,\n    settlement: expenseData.settlement,\n    incomeGeneratingActivity: expenseData.incomeGeneratingActivity,\n    description: expenseData.description,\n    supplier: expenseData.supplier,\n    invoiceDate: expenseData.invoiceDate,\n    type: expenseData.type,\n  });\n\n  await expenseInstance.create(expenseData.amount, expenseData.proof, expenseData.settlement, ipfsHash, owner);\n}\n\ninterface IExpenseData {\n  amount: string;\n  proof: string;\n  localCurrencyAmount: string;\n  localCurrency: string;\n  exchangeRate: string;\n  resultAndActivity: string;\n  category: string;\n  type?: string;\n  country: string;\n  settlement: string;\n  incomeGeneratingActivity: string;\n  description: string;\n  supplier: string;\n  invoiceDate: number;\n}\n"]}